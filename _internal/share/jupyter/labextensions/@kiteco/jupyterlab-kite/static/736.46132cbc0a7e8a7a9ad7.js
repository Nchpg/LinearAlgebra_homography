(self.webpackChunk_kiteco_jupyterlab_kite=self.webpackChunk_kiteco_jupyterlab_kite||[]).push([[736],{4988:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var i=n(2609),o=n.n(i)()((function(t){return t[1]}));o.push([t.id,".lsp-floating-console {\n  position: absolute;\n  width: 600px;\n  height: 350px;\n  right: 0;\n  bottom: 0;\n  background: rgba(255, 255, 255, 0.8);\n  border: 3px solid rgba(204, 204, 204, 0.7);\n  font-size: 12px;\n  overflow-y: auto;\n  margin: 0;\n  list-style-type: none;\n  padding: 5px;\n}\n\n.lsp-code {\n  font-family: monospace;\n  background: #eee;\n  border-radius: 2px;\n  padding: 2px 5px;\n}\n\n.lsp-kind {\n  padding: 2px 5px;\n}\n",""]);const s=o},3075:(t,e,n)=>{"use strict";n.d(e,{Z:()=>d});var i=n(2609),o=n.n(i),s=n(8996),r=n(6801),a=n(2361),l=n(6143),c=o()((function(t){return t[1]}));c.i(s.Z),c.i(r.Z),c.i(a.Z),c.i(l.Z),c.push([t.id,'.cm-lsp-diagnostic {\n  text-decoration-line: underline;\n  /* For Chrome */\n  text-decoration-skip-ink: none;\n}\n\n.cm-lsp-diagnostic-Error {\n  /*\n    "wavy" would be ideal, but there seems to be a bug in Chrome which makes it\n    fail to render the last character see:\n    https://stackoverflow.com/questions/57559588/how-to-make-the-wavy-underline-extend-cover-all-the-characters-in-chrome\n    an alternative would be to use background image trick to simulate the underline\n  */\n\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-error-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Warning {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-warning-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Information {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-information-decoration-color\n  );\n}\n\n.cm-lsp-diagnostic-Hint {\n  text-decoration-style: var(\n    --jp-editor-mirror-lsp-diagnostic-decoration-style\n  );\n  text-decoration-color: var(\n    --jp-editor-mirror-lsp-diagnostic-hint-decoration-color\n  );\n}\n\n/* hover */\n.cm-lsp-hover-available {\n  text-decoration: var(--jp-editor-mirror-lsp-hover-decoration-style);\n  text-decoration-color: var(--jp-editor-mirror-lsp-hover-decoration-color);\n}\n\n/* highlight */\n.cm-lsp-highlight {\n  background-color: var(--jp-editor-mirror-lsp-highlight-background-color);\n}\n',""]);const d=c},4599:(t,e,n)=>{"use strict";n.d(e,{Z:()=>l});var i=n(2609),o=n.n(i),s=n(3075),r=n(1518),a=o()((function(t){return t[1]}));a.i(s.Z),a.i(r.Z),a.push([t.id,".jp-Completer-docpanel {\n  overflow: auto;\n}\n.jp-Completer-docpanel.hidden {\n  display: none;\n}\n\n.jp-Completer-list {\n  scrollbar-width: thin;\n}\n\n.jp-Completer-type {\n  display: table-cell;\n  min-width: 24px;\n  vertical-align: middle;\n}\n\n.jp-Completer-monogram {\n  display: table-cell;\n}\n\n.jp-Completer-icon svg {\n  vertical-align: middle;\n}\n\n.jp-Completer-match {\n  max-width: 320px;\n  min-width: 180px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\n.jp-Completer-typeExtended {\n  padding-left: 40px;\n}\n",""]);const l=a},149:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var i=n(2609),o=n.n(i)()((function(t){return t[1]}));o.push([t.id,".--jp-kite-innernotif-title {\n  margin-bottom: 0.5em;\n  font-size: 1.1em;\n}\n\n.--jp-kite-innernotif-body {\n  margin-bottom: 0.3em;\n}\n\n.--jp-kite-innernotif-main-msg {\n  margin-bottom: 0.4em;\n}\n\n.--jp-kite-innernotif-list {\n  /* override existing jlab list margin */\n  margin: 0;\n}\n\n.--jp-kite-innernotif-no-bullets {\n  /* override existing jlab list margin */\n  padding: 0;\n  padding-left: 1em;\n  list-style-type: none;\n}\n\n.--jp-kite-innernotif-li {\n  margin-bottom: 0.2em;\n}\n\n.--jp-kite-innernotif-button {\n  padding: 0.5em 0.7em 0.5em 0.7em;\n  border: solid var(--jp-border-width) var(--jp-border-color2);\n  font-size: var(--jp-ui-font-size0);\n  margin-top: 1px;\n  margin-bottom: 1px;\n  margin-right: 0px;\n  margin-left: 3px;\n  color: var(--jp-ui-font-color1);\n  background-color: var(--jp-layout-color2);\n}\n\n.--jp-kite-buttonbar {\n  display: flex;\n  flex-direction: row;\n  flex-wrap: nowrap;\n  flex: 0 0 auto;\n  margin-top: 0.4em;\n}\n\n.--jp-kite-buttonbar-spacer {\n  flex-grow: 1;\n  flex-shrink: 1;\n}\n\n.--jp-kite-notifcontainer {\n  width: 410px;\n  right: 7em;\n}\n",""]);const s=o},1518:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var i=n(2609),o=n.n(i)()((function(t){return t[1]}));o.push([t.id,"body[data-jp-theme-light='true'] [data-icon='jupyterlab-kite:completion-icon'] {\n  fill: #11182f;\n  fill-opacity: 60%;\n  transform: scale(0.6);\n}\n\nbody[data-jp-theme-light='false']\n  [data-icon='jupyterlab-kite:completion-icon'] {\n  fill: #d3d3d3;\n  fill-opacity: 60%;\n  transform: scale(0.6);\n}\n\n[data-icon='jupyterlab-kite:status-icon'] {\n  fill: var(--jp-ui-font-color1);\n}\n",""]);const s=o},4929:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var i=n(2609),o=n.n(i)()((function(t){return t[1]}));o.push([t.id,".kite-statusbar-item {\n  overflow: hidden;\n  white-space: nowrap;\n}\n",""]);const s=o},8996:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var i=n(2609),o=n.n(i)()((function(t){return t[1]}));o.push([t.id,":root {\n  /* highlight */\n  --jp-editor-mirror-lsp-highlight-background-color: var(--jp-layout-color2);\n  /* diagnostics */\n  --jp-editor-mirror-lsp-diagnostic-decoration-style: dashed;\n  --jp-editor-mirror-lsp-diagnostic-error-decoration-color: var(\n    --jp-error-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-warning-decoration-color: var(\n    --jp-warn-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-information-decoration-color: var(\n    --jp-info-color1\n  );\n  --jp-editor-mirror-lsp-diagnostic-hint-decoration-color: var(\n    --jp-success-color1\n  );\n  /* hover */\n  --jp-editor-mirror-lsp-hover-decoration-style: dotted;\n  --jp-editor-mirror-lsp-hover-decoration-color: var(--jp-brand-color1);\n}\n",""]);const s=o},6801:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var i=n(2609),o=n.n(i)()((function(t){return t[1]}));o.push([t.id,".cm-s-abcdef {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(144, 199, 255, 0.2);\n}\n\n.cm-s-base16-dark {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-base16-light {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(186, 192, 161, 0.1);\n}\n\n.cm-s-default {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-hopscotch {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(207, 18, 255, 0.2);\n}\n\n.cm-s-material {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 255, 58, 0.2);\n}\n\n.cm-s-mbo {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-material {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-mdn-like {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-seti {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n\n.cm-s-solarized {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-the-matrix {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.1);\n}\n\n.cm-s-xq-light {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n\n.cm-s-zenburn {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(239, 231, 171, 0.2);\n}\n",""]);const s=o},2361:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var i=n(2609),o=n.n(i)()((function(t){return t[1]}));o.push([t.id,"body[data-jp-theme-light='false'] .cm-s-jupyter {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(151, 173, 255, 0.3);\n}\n",""]);const s=o},6143:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var i=n(2609),o=n.n(i)()((function(t){return t[1]}));o.push([t.id,"body[data-jp-theme-light='true'] .cm-s-jupyter {\n  --jp-editor-mirror-lsp-highlight-background-color: rgba(18, 69, 255, 0.1);\n}\n",""]);const s=o},1074:(t,e,n)=>{"use strict";n.d(e,{Z:()=>i});const i='<svg width="24px" height="24px" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">\n    <g id="kite-logo" transform="translate(53,14)">\n        <polygon id="Path" points="150.433658 147.335971 90.1889836 260.668594 221.53804 372.861838 264.798844 205.622337 150.433658 147.335971"></polygon>\n        <polygon id="Path" points="104.003956 0 0 183.653682 79.7565429 251.767194 146.303408 134.23311 268.252587 192.341449 294.529519 90.7942788 104.003956 0"></polygon>\n    </g>\n</svg>'},8104:(t,e,n)=>{"use strict";n.d(e,{i:()=>a,R:()=>l});var i=n(7635),o=n(5173),s=n(6635),r=n(1074);const a={status:"",short:"",long:""};class l extends i.VDomModel{constructor(t){super(),this._icon=new o.LabIcon({name:"jupyterlab-kite:status-icon",svgstr:r.Z}),this._adapter=null,this._connectionClosed=()=>{this.setState({disconnected:!0})},this._onChange=()=>{this.stateChanged.emit(void 0)},this._language_server_manager=t,this.icon.bindprops({className:"kite-logo"}),this._state={kiteUninstalled:!1,serverUnreachable:!1,disconnected:!1,kiteStatus:a}}async refresh(t,e){try{await this.languageServerManager.fetchSessions()}catch(t){return console.warn("Could not get server status:",t),void this.setState({serverUnreachable:!0})}if(!await this.languageServerManager.fetchKiteInstalled())return console.warn("Kite engine not installed"),void this.setState({kiteUninstalled:!0});if(!this.reloadRequired&&t&&e){const n=await t.fetchKiteStatus(e);this.setState({kiteStatus:n})}}get languageServerManager(){return this._language_server_manager}get icon(){return this._icon}get reloadRequired(){return this.state.disconnected}get message(){return this.state.serverUnreachable?{text:"Kite: server extension unreachable",tooltip:"The jupyter-kite server extension could not be reached."}:this.state.kiteUninstalled?{text:"Kite: engine not installed",tooltip:"Kite engine install could not be found."}:this.reloadRequired?{text:"Kite: disconnected (reload page)",tooltip:"The connection to Kite was interrupted. Save your changes and reload the page to reconnect."}:this.adapter&&this.state.kiteStatus.status?{text:"Kite: "+this.state.kiteStatus.short,tooltip:this.state.kiteStatus.long}:{text:"Kite: not running",tooltip:"Kite is not reachable."}}get adapter(){return this._adapter}set adapter(t){this._adapter&&this._adapter.connection_manager.closed.disconnect(this._connectionClosed),t&&t.connection_manager.closed.connect(this._connectionClosed),this._adapter=t}get state(){return this._state}setState(t){const e=Object.assign(Object.assign({},this._state),t);(0,s.isEqual)(this._state,e)||(this._state=e,this._onChange())}}},7736:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>ne});var i=n(6242),o=n(7635),s=n(6472),r=n(9433),a=n(3087),l=n(7897),c=n(1840),d=n(9837),h=n(3067),u=n(2362),_=n(8072),p=n(6062),g=n.n(p),m=n(4599);g()(m.Z,{insert:"head",singleton:!1}),m.Z.locals;var f=n(6271),v=n.n(f),w=n(1023),y=n(4929);g()(y.Z,{insert:"head",singleton:!1}),y.Z.locals;class b extends o.VDomRenderer{constructor(t){super(t),t.refresh().catch((t=>console.log(t))),this.addClass(_.item),this.addClass("kite-statusbar-item"),this.title.caption="Kite Status"}render(){if(!this.model||!this.model.adapter||!this.isSupportedDocumentPath(this.model.adapter.document_path))return this.setHidden(!0),null;this.setHidden(!1);const t={};return this.model.reloadRequired&&(t.style={cursor:"pointer"},t.onClick=()=>window.location.reload()),v().createElement(_.GroupItem,Object.assign({},t,{spacing:4,title:this.model.message.tooltip}),v().createElement(this.model.icon.react,{top:"2px",kind:"statusBar"}),v().createElement(_.TextItem,{source:this.model.message.text}))}isSupportedDocumentPath(t){return".py"===(0,w.extname)(t)||".ipynb"===(0,w.extname)(t)}}var x=n(8104);class k extends Map{constructor(t){super(t.map((t=>[new RegExp(t.pattern),t.replacement])))}_override_for(t){for(let[e,n]of this)if(t.match(e))return t.replace(e,n);return null}}class C extends k{constructor(t){super(t),this.overrides=t}get reverse(){return this.type(this.overrides.map((t=>t.reverse)))}}class j extends C{type(t){return new j(t)}override_for(t){return super._override_for(t)}}class S extends C{type(t){return new S(t)}override_for(t){return super._override_for(t)}replace_all(t,e=this){let n=new Array,i=new Array;for(let o=0;o<t.length;o++){let s=t[o],r=e.override_for(s);n.push(null==r?s:r),i.push(null!=r)}return{lines:n,skip_inspect:i}}reverse_replace_all(t){return this.replace_all(t,this.reverse).lines}}var E,I,L=n(6988),T=n(6168),M=n(4810);!function(t){t.URL_NS="lsp"}(E||(E={}));class P{constructor(t){this.on_new_connection=t=>{t.on("error",(e=>{console.warn(e);let n=e.length&&e.length>=1?e[0]:new Error;-1!==n.message.indexOf("code = 1005")?console.warn(`LSP: Connection failed for ${t}`):-1!==n.message.indexOf("code = 1006")?console.warn("LSP: Connection closed by the server "):console.error("LSP: Connection error:",e),this.forEachDocumentOfConnection(t,(e=>{console.warn("LSP: disconnecting "+e.id_path),this.closed.emit({connection:t,virtual_document:e}),this.ignored_languages.add(e.language),console.warn(`Cancelling further attempts to connect ${e.id_path} and other documents for this language (no support from the server)`)}))})),t.on("serverInitialized",(e=>{this.forEachDocumentOfConnection(t,(e=>{this.initialized.emit({connection:t,virtual_document:e})}))})),t.on("close",(e=>{e?(console.warn("LSP: Connection closed"),this.forEachDocumentOfConnection(t,(e=>{this.closed.emit({connection:t,virtual_document:e})}))):console.warn("LSP: Connection unexpectedly disconnected")}))},this.connections=new Map,this.documents=new Map,this.ignored_languages=new Set,this.connected=new T.Signal(this),this.initialized=new T.Signal(this),this.closed=new T.Signal(this),this.documents_changed=new T.Signal(this),this.language_server_manager=t.language_server_manager,this.kite_status_model=t.kite_status_model,I.setLanguageServerManager(t.language_server_manager)}connect_document_signals(t){t.foreign_document_opened.connect(this.on_foreign_document_opened,this),t.foreign_document_closed.connect(this.on_foreign_document_closed,this),this.documents.set(t.id_path,t),this.documents_changed.emit(this.documents)}disconnect_document_signals(t,e=!0){t.foreign_document_opened.disconnect(this.on_foreign_document_opened,this),t.foreign_document_closed.disconnect(this.on_foreign_document_closed,this),this.documents.delete(t.id_path);for(const e of t.foreign_documents.values())this.disconnect_document_signals(e,!1);e&&this.documents_changed.emit(this.documents)}on_foreign_document_opened(t,e){console.log("LSP: ConnectionManager received foreign document: ",e.foreign_document.id_path)}on_foreign_document_closed(t,e){const{foreign_document:n}=e;this.disconnect_document_signals(n)}async connect_socket(t){console.log("LSP: Connection Socket",t);let{virtual_document:e,language:n}=t;this.connect_document_signals(e);const i=P.solve_uris(e,n),o=this.language_server_manager.getServerId({language:n}),s=await I.connection(n,o,i,this.on_new_connection,this.kite_status_model);return this.connections.set(e.id_path,s),s}forEachDocumentOfConnection(t,e){for(const[n,i]of this.connections.entries()){if(t!==i)continue;const o=this.documents.get(n);o&&e(o)}}async retry_to_connect(t,e,n=-1){let{virtual_document:i}=t;if(this.ignored_languages.has(i.language))return;let o=1e3*e,s=!1;for(;0!==n&&!s;)await this.connect(t).then((()=>{s=!0})).catch((t=>{console.warn(t)})),console.log("LSP: will attempt to re-connect in "+o/1e3+" seconds"),await(0,L._v)(o),o=o<5e3?o+500:o}async connect(t){console.log("LSP: connection requested",t);let e=await this.connect_socket(t),{virtual_document:n,document_path:i}=t;if(!e.isReady)try{await(0,L.EU)((()=>e.isReady),200,200)}catch(t){return void console.warn(`LSP: Connect timed out for ${n.id_path}`)}return console.log("LSP:",i,n.id_path,"connected."),this.connected.emit({connection:e,virtual_document:n}),e}unregister_document(t){this.connections.delete(t.id_path),this.documents_changed.emit(this.documents)}}function R(t,e){return e.start.line===e.end.line?t.line===e.start.line&&t.column>=e.start.column&&t.column<=e.end.column:t.line===e.start.line&&t.column>=e.start.column&&t.line<e.end.line||t.line>e.start.line&&t.column<=e.end.column&&t.line===e.end.line||t.line>e.start.line&&t.line<e.end.line}!function(t){t.solve_uris=function(t,e){const n=M.PageConfig.getBaseUrl().replace(/^http/,"ws"),i=M.PageConfig.getOption("rootUri"),o=M.PageConfig.getOption("virtualDocumentsUri"),s=t.has_lsp_supported_file?i:o,r=I.getLanguageServerManager().getServerId({language:e});return{base:s,document:M.URLExt.join(s,t.uri),server:M.URLExt.join("ws://jupyter-kite",e),socket:M.URLExt.join(n,E.URL_NS,"ws",r)}}}(P||(P={})),function(t){const e=new Map;let i,o;t.getLanguageServerManager=function(){return o},t.setLanguageServerManager=function(t){o=t},t.connection=async function(t,o,s,r,a){null==i&&(i=n.e(16).then(n.bind(n,1672)));const{LSPConnection:l}=await i;let c=e.get(o);if(null==c){const n=new WebSocket(s.socket),i=new l({languageId:t,serverUri:s.server,rootUri:s.base,kite_status_model:a});i.setMaxListeners(999),e.set(o,i),i.connect(n),r(i)}return c=e.get(o),c}}(I||(I={}));class O{constructor(t){this.version=0,this._document=t}get text(){return this._document.value}get uri(){return P.solve_uris(this._document,this.languageId).document}get languageId(){return this._document.language}}class K{constructor(t,e,n,i,o,s,r,a){this.path=e,this.file_extension=s,this.has_lsp_supported_file=r,this.parent=a,this.isDisposed=!1,this.blank_lines_between_cells=2,this.language=t;let l=t in n?n[t]:null;this.cell_magics_overrides=new j(l?l.cell_magics:[]),this.line_magics_overrides=new S(l?l.line_magics:[]),this.foreign_extractors_registry=i,this.foreign_extractors=this.language in this.foreign_extractors_registry?this.foreign_extractors_registry[this.language]:[],this.virtual_lines=new Map,this.source_lines=new Map,this.foreign_documents=new Map,this.overrides_registry=n,this.standalone=o,this.instance_id=K.instances_count,K.instances_count+=1,this.unused_standalone_documents=new L.Gl((()=>new Array)),this._remaining_lifetime=10,this.foreign_document_closed=new T.Signal(this),this.foreign_document_opened=new T.Signal(this),this.changed=new T.Signal(this),this.unused_documents=new Set,this.document_info=new O(this),this.clear()}dispose(){if(!this.isDisposed){this.parent=null;for(const t of this.foreign_documents.values())t.dispose();this.close_all_foreign_documents(),this.foreign_documents.clear(),this.source_lines.clear(),this.unused_documents.clear(),this.unused_standalone_documents.clear(),this.virtual_lines.clear(),this.cell_magics_overrides=null,this.document_info=null,this.foreign_extractors=null,this.foreign_extractors_registry=null,this.line_magics_overrides=null,this.lines=null,this.overrides_registry=null,this.isDisposed=!0}}get remaining_lifetime(){return this.parent?this._remaining_lifetime:1/0}set remaining_lifetime(t){this.parent&&(this._remaining_lifetime=t)}clear(){this.unused_standalone_documents.clear();for(let t of this.foreign_documents.values())t.clear(),t.standalone&&this.unused_standalone_documents.get(t.language).push(t);this.unused_documents=new Set(this.foreign_documents.values()),this.virtual_lines.clear(),this.source_lines.clear(),this.last_virtual_line=0,this.last_source_line=0,this.lines=[]}forward_closed_signal(t,e){this.foreign_document_closed.emit(e)}forward_opened_signal(t,e){this.foreign_document_opened.emit(e)}open_foreign(t,e,n){let i=new K(t,this.path,this.overrides_registry,this.foreign_extractors_registry,e,n,!1,this);const o={foreign_document:i,parent_host:this};return this.foreign_document_opened.emit(o),i.foreign_document_closed.connect(this.forward_closed_signal,this),i.foreign_document_opened.connect(this.forward_opened_signal,this),this.foreign_documents.set(i.virtual_id,i),i}document_at_source_position(t){let e=this.source_lines.get(t.line);if(null==e)return this;let n={line:e.editor_line,column:t.ch};for(let[t,{virtual_document:i}]of e.foreign_documents_map)if(R(n,t)){let e={line:n.line-t.start.line,ch:n.column-t.start.column};return i.document_at_source_position(e)}return this}is_within_foreign(t){let e=this.source_lines.get(t.line),n={line:e.editor_line,column:t.ch};for(let[t]of e.foreign_documents_map)if(R(n,t))return!0;return!1}virtual_position_at_document(t){let e=this.source_lines.get(t.line),n=e.virtual_line,i={line:e.editor_line,column:t.ch};for(let[t,{virtual_line:n,virtual_document:o}]of e.foreign_documents_map)if(R(i,t)){let e={line:i.line-t.start.line,ch:i.column-t.start.column};return o.is_within_foreign(e)?this.virtual_position_at_document(e):(e.line+=n,e)}return{ch:t.ch,line:n}}choose_foreign_document(t){let e,n=this.foreign_documents.has(t.language);if(!t.standalone&&n)e=this.foreign_documents.get(t.language),this.unused_documents.delete(e);else{let n=this.unused_standalone_documents.get(t.language);t.standalone&&n.length>0?(e=n.pop(),this.unused_documents.delete(e)):e=this.open_foreign(t.language,t.standalone,t.file_extension)}return e}extract_foreign_code(t,e,n){let i=new Map;for(let o of this.foreign_extractors){if(!o.has_foreign_code(t))continue;let s=o.extract_foreign_code(t),r="";for(let t of s){if(null!==t.foreign_code){let s=this.choose_foreign_document(o);i.set(t.range,{virtual_line:s.last_virtual_line,virtual_document:s});let r={line:n.line+t.range.start.line,column:n.column+t.range.start.column};s.append_code_block(t.foreign_code,e,r,t.virtual_shift)}null!=t.host_code&&(r+=t.host_code)}t=r}return{cell_code_kept:t,foreign_document_map:i}}decode_code_block(t){let e=this.cell_magics_overrides.reverse.override_for(t);return null!=e?e:this.line_magics_overrides.reverse_replace_all(t.split("\n")).join("\n")}prepare_code_block(t,e,n={line:0,column:0}){let i,o,{cell_code_kept:s,foreign_document_map:r}=this.extract_foreign_code(t,e,n);t=s;let a=this.cell_magics_overrides.override_for(t);if(null!=a)i=a.split("\n"),o=i.map((t=>[this.id_path]));else{let e=this.line_magics_overrides.replace_all(t.split("\n"));i=e.lines,o=e.skip_inspect.map((t=>t?[this.id_path]:[]))}return{lines:i,foreign_document_map:r,skip_inspect:o}}append_code_block(t,e,n={line:0,column:0},i){let o=t.split("\n"),{lines:s,foreign_document_map:r,skip_inspect:a}=this.prepare_code_block(t,e,n);for(let t=0;t<s.length;t++)this.virtual_lines.set(this.last_virtual_line+t,{skip_inspect:a[t],editor:e,source_line:this.last_source_line+t});for(let t=0;t<o.length;t++)this.source_lines.set(this.last_source_line+t,{editor_line:t,editor_shift:{line:n.line-((null==i?void 0:i.line)||0),column:0===t?n.column-((null==i?void 0:i.column)||0):0},editor:e,foreign_documents_map:r,virtual_line:this.last_virtual_line+t});this.last_virtual_line+=s.length,this.lines.push(s.join("\n")+"\n");for(let t=0;t<this.blank_lines_between_cells;t++)this.virtual_lines.set(this.last_virtual_line+t,{skip_inspect:[this.id_path],editor:e,source_line:null});this.last_virtual_line+=this.blank_lines_between_cells,this.last_source_line+=o.length}get value(){let t="\n".repeat(this.blank_lines_between_cells);return this.lines.join(t)}getTokenAt(t){let e=this.get_editor_at_virtual_line(t),n=this.transform_virtual_to_editor(t);return e.getTokenAt(n)}close_expired_documents(){for(let t of this.unused_documents.values())t.remaining_lifetime-=1,t.remaining_lifetime<=0&&this.close_foreign(t)}close_foreign(t){console.log("LSP: closing document",t),this.foreign_document_closed.emit({foreign_document:t,parent_host:this}),this.foreign_documents.delete(t.virtual_id),t.close_all_foreign_documents(),t.foreign_document_closed.disconnect(this.forward_closed_signal,this),t.foreign_document_opened.disconnect(this.forward_opened_signal,this)}close_all_foreign_documents(){for(let t of this.foreign_documents.values())this.close_foreign(t)}get virtual_id(){return this.standalone?this.instance_id+"("+this.language+")":this.language}get ancestry(){return this.parent?this.parent.ancestry.concat([this]):[this]}get id_path(){return this.parent?this.parent.id_path+"-"+this.virtual_id:this.virtual_id}get uri(){return this.parent?this.path+"."+this.id_path+"."+this.file_extension:this.path}transform_source_to_editor(t){let e=this.source_lines.get(t.line),n=e.editor_line,i=e.editor_shift;return{ch:t.ch+(0===n?i.column:0),line:n+i.line}}transform_virtual_to_editor(t){let e=this.transform_virtual_to_source(t);return this.transform_source_to_editor(e)}transform_virtual_to_source(t){return{ch:t.ch,line:this.virtual_lines.get(t.line).source_line}}get root(){return null==this.parent?this:this.parent.root}get_editor_at_virtual_line(t){let e=t.line;return this.virtual_lines.has(e)||(e-=1),this.virtual_lines.get(e).editor}get_editor_at_source_line(t){return this.source_lines.get(t.line).editor}maybe_emit_changed(){this.value!==this.previous_value&&this.changed.emit(this),this.previous_value=this.value;for(let t of this.foreign_documents.values())t.maybe_emit_changed()}}K.instances_count=0;var U=n(4988);g()(U.Z,{insert:"head",singleton:!1}),U.Z.locals;class D{}class N extends D{log(...t){console.log("LSP: ",...t)}warn(...t){console.warn("LSP: ",...t)}error(...t){console.error("LSP: ",...t)}}class A{constructor(t,e,n,i,o,s){this.language=t,this.file_extension=e,this.path=n,this.overrides_registry=i,this.foreign_code_extractors=o,this.has_lsp_supported_file=s,this.isDisposed=!1,this.is_update_in_progress=!1,this.update_lock=!1,this._event_wrappers=new Map,this.create_virtual_document(),this.documents_updated=new T.Signal(this),this.documents_updated.connect(this.on_updated,this),this.console=new N}create_virtual_document(){this.virtual_document=new K(this.language(),this.path(),this.overrides_registry,this.foreign_code_extractors,!1,this.file_extension(),this.has_lsp_supported_file)}dispose(){if(!this.isDisposed){this.documents_updated.disconnect(this.on_updated,this);for(let[[t],e]of this._event_wrappers.entries())this.forEveryBlockEditor((n=>{n.off(t,e)}),!1);this._event_wrappers.clear(),this.virtual_document.dispose(),this.virtual_document=null,this.overrides_registry=null,this.foreign_code_extractors=null,this.code_extractors=null,this.isDisposed=!0}}on_updated(t,e){try{e.close_expired_documents()}catch(t){this.console.warn("LSP: Failed to close expired documents")}}transform_virtual_to_editor(t){return this.virtual_document.transform_virtual_to_editor(t)}can_update(){return!this.isDisposed&&!this.is_update_in_progress&&!this.update_lock}async with_update_lock(t){await(0,L.EU)((()=>this.can_update()),12,10).then((()=>{try{this.update_lock=!0,t()}finally{this.update_lock=!1}}))}async update_documents(){return new Promise((async(t,e)=>{await(0,L.EU)((()=>this.can_update()),10,5).then((()=>{!this.isDisposed&&this.virtual_document||t();try{this.is_update_in_progress=!0,this.perform_documents_update(),this.virtual_document&&(this.documents_updated.emit(this.virtual_document),this.virtual_document.maybe_emit_changed()),t()}catch(t){this.console.warn("Documents update failed:",t),e(t)}finally{this.is_update_in_progress=!1}}))}))}document_at_root_position(t){let e=t;return this.virtual_document.root.document_at_source_position(e)}root_position_to_virtual_position(t){let e=t;return this.virtual_document.root.virtual_position_at_document(e)}get_editor_at_root_position(t){return this.virtual_document.root.get_editor_at_source_line(t)}root_position_to_editor(t){return this.virtual_document.root.transform_source_to_editor(t)}on(t,e,...n){let i=(t,...n)=>{try{return e(this,...n)}catch(e){this.console.warn("Wrapped handler (which should accept a CodeMirror Editor instance) failed",{error:e,instance:t,args:n,this:this})}};this._event_wrappers.set([t,e],i),this.forEveryBlockEditor((e=>{e.on(t,i)}))}off(t,e,...n){let i=this._event_wrappers.get([t,e]);this.forEveryBlockEditor((e=>{e.off(t,i)}))}}class $ extends A{constructor(t,e,n,i){return super(t,e,n,{},{},!0),this.has_cells=!1,this.cm_editor=i,new Proxy(this,{get:function(t,e,n){return e in i&&!(e in t)?i[e]:Reflect.get(t,e,n)}})}transform_virtual_to_editor(t){return t}transform_editor_to_root(t,e){return e}get_editor_index(t){return 0}get_cm_editor(t){return this.cm_editor}perform_documents_update(){this.isDisposed||(this.virtual_document.clear(),this.virtual_document.append_code_block(this.cm_editor.getValue(),this.cm_editor))}addEventListener(t,e){this.cm_editor.getWrapperElement().addEventListener(t,e)}forEveryBlockEditor(t){t(this.cm_editor)}}var q,W,H,Z=n(5173),J=n(4767);function F(t){const e={};for(let n of Object.keys(t))e[t[n]]=n;return e}!function(t){t.Error=1,t.Warning=2,t.Information=3,t.Hint=4}(q||(q={})),function(t){t.Text=1,t.Method=2,t.Function=3,t.Constructor=4,t.Field=5,t.Variable=6,t.Class=7,t.Interface=8,t.Module=9,t.Property=10,t.Unit=11,t.Value=12,t.Enum=13,t.Keyword=14,t.Snippet=15,t.Color=16,t.File=17,t.Reference=18,t.Folder=19,t.EnumMember=20,t.Constant=21,t.Struct=22,t.Event=23,t.Operator=24,t.TypeParameter=25}(W||(W={})),function(t){t.Text=1,t.Read=2,t.Write=3}(H||(H={})),F(q);const B=F(W);var V;F(H),function(t){t.Invoked=1,t.TriggerCharacter=2,t.TriggerForIncompleteCompletions=3}(V||(V={}));class z{static lsp_to_cm(t){return{line:t.line,ch:t.character}}static lsp_to_ce(t){return{line:t.line,column:t.character}}static cm_to_ce(t){return{line:t.line,column:t.ch}}static ce_to_cm(t){return{line:t.line,ch:t.column}}}var G=n(1074);class X extends u.DataConnector{constructor(t){super(),this.isDisposed=!1,this.responseType=r.CompletionHandler.ICompletionItemsResponseType,this._trigger_kind=V.Invoked,this.suppress_auto_invoke_in=["comment"],this.icon=new Z.LabIcon({name:"jupyterlab-kite:completion-icon",svgstr:G.Z}),this._editor=t.editor,this._connections=t.connections,this.virtual_editor=t.virtual_editor,this.options=t,this.fetchAbort=new AbortController,t.session&&(this._kernel_connector=new r.KernelConnector({session:t.session})),this.icon.bindprops({className:"kite-logo"})}dispose(){this.isDisposed||(delete this._connections,delete this._kernel_connector,delete this.virtual_editor,delete this.options,delete this._editor,delete this.icon,delete this.isDisposed,delete this.fetchAbort)}abort(){this.fetchAbort.abort()}fetch(t){return new Promise((async(e,n)=>{const i=new AbortController;this.fetchAbort.abort(),this.fetchAbort=i;let o=[-1,-1];i.signal.addEventListener("abort",(()=>{e({start:o[0],end:o[1],items:[]})}),{once:!0});let s=this._editor;const r=s.getCursorPosition(),a=s.getTokenForPosition(r);if(a.type&&-1!==this.suppress_auto_invoke_in.indexOf(a.type))return void console.log("[Kite][Completer] Suppressing completer auto-invoke in",a.type);const l=s.getPositionAt(a.offset),c=s.getPositionAt(a.offset+a.value.length);if(!l||!c)return console.log("[Kite][Completer] No start or end position found"),void e(X.EmptyICompletionItemsReply);let d=r.column-l.column-1;const h=a.value[r.column-l.column-1];let u=a.value.slice(0,d+1);o=[a.offset+1,a.offset+u.length];let _=this.transform_from_editor_to_root(l),p=this.transform_from_editor_to_root(c),g=this.transform_from_editor_to_root(r),m=this.virtual_editor,f=m.document_at_root_position(_),v=m.root_position_to_virtual_position(_),w=m.root_position_to_virtual_position(p),y=m.root_position_to_virtual_position(g);const b=this._trigger_kind===V.Invoked,x=!b&&"string"===a.type,k=/^[a-zA-Z\.\'\"]+/,C=()=>this._kernel_connector&&t&&!x&&(k.test(h)||b)?this._kernel_connector.fetch(t).catch((()=>X.EmptyIReply)):X.EmptyIReply,[j,S]=await Promise.all([b?C():(()=>{const t=new Promise((t=>{setTimeout(t,500,X.EmptyIReply)}));return Promise.race([t,C()])})(),(async()=>{try{return await this.fetch_kite(a,h,v,w,y,f,d)}catch(t){return{start:o[0],end:o[1],items:[]}}})()]),E=this.merge_replies(j,S);i.signal.aborted||e(E)}))}async fetch_kite(t,e,n,i,o,s,r){let a=this._connections.get(s.id_path);if(!a)return console.log("[Kite][Completer] No LSP Connection found"),X.EmptyICompletionItemsReply;const l=await a.getCompletion(o,{start:n,end:i,text:t.value},s.document_info,!1,e,this.trigger_kind).catch((t=>console.error(t)));console.log("[Kite][Completer] Fetched",l);let c=t.value.slice(0,r+1),d=!0,h=[],u=s.get_editor_at_virtual_line(o).getLineTokens(o.line).map((t=>t.string)).join("");return l.forEach((e=>{var i;if(!e.textEdit||!("range"in e.textEdit))return;let s=null===(i=e.textEdit)||void 0===i?void 0:i.range,r=e.insertText?e.insertText:e.label;if(s){if(s.start.character<n.ch){let t=u.substring(s.start.character,n.ch);if(!r.startsWith(t))return void console.log("[Kite][Completer] Disposing of un-insertable completion: %s",e.insertText?e.insertText:e.label);r=r.substring(t.length)}else if(s.start.character>n.ch+1)return void console.log("[Kite][Completer] Disposing of un-insertable completion: %s",e.insertText?e.insertText:e.label);if(s.end.character>o.ch){let t=u.substring(o.ch,s.end.character);if(!r.endsWith(t))return void console.log("[Kite][Completer] Disposing of un-insertable completion: %s",e.insertText?e.insertText:e.label);r=r.substring(0,r.length-t.length)}else if(s.end.character<o.ch)return void console.log("[Kite][Completer] Disposing of un-insertable completion: %s",e.insertText?e.insertText:e.label)}r!==e.insertText&&(console.log("[Kite][Completer] Trimmed %s => %s",e.insertText,r),e.insertText=r);let a={label:e.label,insertText:e.insertText,type:e.hint?e.hint:e.kind?B[e.kind]:"",icon:this.icon,documentation:J.A_.is(e.documentation)?e.documentation.value:e.documentation,filterText:e.filterText,noFilter:!0},l=e.insertText?e.insertText:e.label;l.toLowerCase().startsWith(c.toLowerCase())&&(d=!1,c!==t.value&&l.toLowerCase().startsWith(t.value.toLowerCase())&&(c=t.value)),h.push(a)})),{start:t.offset+(d?1:0),end:t.offset+c.length,items:h}}merge_replies(t,e){const n=this.transform(t);if(!n.items.length)return e;if(!e.items.length)return n;const i=new Set(e.items.map((t=>t.label)));return n.items=n.items.filter((t=>!i.has(t.label))),console.log("[Kite]: Merging",e,n),-1===e.start?Object.assign(Object.assign({},t),{items:e.items.concat(n.items)}):Object.assign(Object.assign({},e),{items:e.items.concat(n.items)})}transform(t){const e=new Array,n=(t.metadata||{})._jupyter_types_experimental;return n?n.forEach((t=>{const n=t.text,i=t.type;e.push({label:n,type:"<unknown>"===i?"":i})})):t.matches.forEach((t=>{e.push({label:t})})),{start:t.start,end:t.end,items:e}}transform_from_editor_to_root(t){let e=this._editor.editor,n=z.ce_to_cm(t);return this.virtual_editor.transform_editor_to_root(e,n)}get trigger_kind(){return this._trigger_kind}set trigger_kind(t){this._trigger_kind=t}with_trigger_kind(t,e){try{return this.trigger_kind=t,e()}finally{this.trigger_kind=V.Invoked}}}!function(t){t.EmptyICompletionItemsReply={start:-1,end:-1,items:[]},t.EmptyIReply={start:-1,end:-1,matches:[],metadata:{}}}(X||(X={}));var Y,Q,tt=n(6510);class et{constructor(t,e,n,i=new Array){this.editor=t,this.virtual_document=e,this.jupyterlab_components=n,this.isDisposed=!1,this.saveChange=(t,e)=>{this.last_change=e},this.editor.on("change",this.saveChange),this.features=new Map;for(let t of i)t.register(),t.is_registered||this.editor.console.warn("The feature ",t,"was not registered properly"),this.features.set(t.name,t)}async updateAfterChange(){this.jupyterlab_components.remove_tooltip();try{await(0,L.EU)((()=>null!=this.last_change),30,22)}catch(t){return void console.log("No change obtained from CodeMirror editor within the expected time of 0.66s")}let t,e=this.last_change;try{t=this.editor.getDoc().getCursor("end")}catch(t){return void console.log("LSP: Root positon not found")}try{let n=this.editor.document_at_root_position(t);if(this.virtual_document!==n)return!0;if(!e||!e.text.length||!e.text[0].length)return!0;for(let n of this.features.values())n.afterChange(e,t);return!0}catch(t){this.editor.console.log("updateAfterChange failure"),this.editor.console.error(t)}this.invalidateLastChange()}invalidateLastChange(){this.last_change=null}dispose(){if(!this.isDisposed){for(let t of this.features.values())t.remove();this.features.clear(),this.editor.off("change",this.saveChange),this.editor=null,this.isDisposed=!0}}}function nt(t,e){let n=0,i=0;for(let o of e){if(!(o.length+1<=t)){i=t;break}t-=o.length+1,n+=1}return{line:n,column:i}}function it(t,e,n=!1){let i=n?0:1,o=0;for(let n=0;n<e.length;n++){let s=e[n];if(!(t.line>n)){o+=t.column;break}o+=s.length+i}return o}function ot(t,e){return it(z.lsp_to_ce(t),e)}(Q=Y||(Y={}))[Q.CellContextMenu=0]="CellContextMenu",Q[Q.FileEditorContextMenu=1]="FileEditorContextMenu";class st{constructor(t,e,n,i,o){this.virtual_editor=t,this.virtual_document=e,this.connection=n,this.jupyterlab_components=i,this.status_message=o,this.editor_handlers=new Map,this.connection_handlers=new Map,this.wrapper_handlers=new Map,this.is_registered=!1}register(){for(let[t,e]of this.editor_handlers)this.virtual_editor.on(t,e);for(let[t,e]of this.connection_handlers)this.connection.on(t,e);this.wrapper=this.virtual_editor.getWrapperElement();for(let[t,e]of this.wrapper_handlers)this.wrapper.addEventListener(t,e);this.is_registered=!0}isEnabled(){return!0}remove(){for(let[t,e]of this.editor_handlers)this.virtual_editor.off(t,e);this.editor_handlers.clear();for(let[t,e]of this.connection_handlers)this.connection.off(t,e);this.connection_handlers.clear();for(let[t,e]of this.wrapper_handlers)this.wrapper.removeEventListener(t,e);this.wrapper_handlers.clear()}afterChange(t,e){}range_to_editor_range(t,e){let n=z.lsp_to_cm(t.start),i=z.lsp_to_cm(t.end);if(null==e){let t=this.transform_virtual_position_to_root_position(n);e=this.virtual_editor.get_editor_at_root_position(t)}return{start:this.virtual_document.transform_virtual_to_editor(n),end:this.virtual_document.transform_virtual_to_editor(i),editor:e}}position_from_mouse(t){return this.virtual_editor.coordsChar({left:t.clientX,top:t.clientY},"window")}transform_virtual_position_to_root_position(t){let e=this.virtual_document.virtual_lines.get(t.line).editor,n=this.virtual_document.transform_virtual_to_editor(t);return this.virtual_editor.transform_editor_to_root(e,n)}get_cm_editor(t){return this.virtual_editor.get_cm_editor(t)}get_language_at(t,e){return e.getModeAt(t).name}extract_last_character(t){return"paste"===t.origin?t.text[0][t.text.length-1]:t.text[0][0]}highlight_range(t,e){return t.editor.getDoc().markText(t.start,t.end,{className:e})}is_whole_document_edit(t){let e=this.virtual_document.value,n=e.split("\n"),i=t.range,o=z.lsp_to_ce;return 0===it(o(i.start),n)&&it(o(i.end),n)===e.length}async apply_edit(t){let e,n,i=this.virtual_document.document_info.uri,o=t.documentChanges?t.documentChanges.map((t=>t)):function(t){let e=[];for(let n of Object.keys(t))e.push({textDocument:{uri:n},edits:t[n]});return e}(t.changes),s=null,r=[];for(let t of o){let o=t.textDocument.uri;if(decodeURI(o)!==decodeURI(i)&&decodeURI(o)!=="/"+decodeURI(i))r.push("Workspace-wide edits not implemented ("+decodeURI(o)+" != "+decodeURI(i)+")");else{let i;if(n=1===t.edits.length&&this.is_whole_document_edit(t.edits[0]),n)i=t.edits[0];else{s=0;let e=this.virtual_document.value,n=e.split("\n"),o=new Map;for(let e of t.edits){let t=ot(e.range.start,n);o.has(t)?console.warn("Edits should not overlap, ignoring an overlapping edit"):(o.set(t,e),s+=1)}let r=new L.Gl((()=>[])),a="",l=0,c=0,d=0,h=[...o.keys()].sort(((t,e)=>t-e));for(let t of h){let i=o.get(t),s=e.slice(l,t);for(let t=0;t<s.split("\n").length;t++)r.get_or_create(c).push(d),c+=1,d+=1;a+=s+i.newText;let h=ot(i.range.end,n),u=e.slice(t,h);for(let t=0;t<i.newText.split("\n").length;t++)t<u.length&&(c+=1),d+=1,r.get_or_create(c).push(d);l=h}a+=e.slice(l,e.length),i={range:{start:{line:0,character:0},end:{line:n.length-1,character:n[n.length-1].length}},newText:a},console.assert(this.is_whole_document_edit(i))}e=this.apply_single_edit(i)}}return{appliedChanges:s,modifiedCells:e,wasGranular:!n,errors:r}}replace_fragment(t,e,n,i,o,s,r=!1){let a=this.virtual_document,l=t.split("\n").slice(n.line-o.line,i.line-o.line).join("\n");l.endsWith("\n")&&(l=l.slice(0,-1));let c=e.getDoc(),d=c.getValue("\n"),{lines:h}=a.prepare_code_block(d,e),u=h.join("\n");if(r){let e=z.cm_to_ce,n=it(e(o),h),i=it(e(s),h);l=u.slice(0,n)+t+u.slice(i)}if(u===l)return 0;let _=a.decode_code_block(l),p=c.getCursor();c.replaceRange(_,{line:0,ch:0},{line:i.line-n.line+1,ch:0});try{c.setCursor(p,p.ch,{scroll:!1})}catch(t){console.log("Could not place the cursor back",t)}return 1}apply_single_edit(t){let e=this.virtual_document,n=0,i=z.lsp_to_cm(t.range.start),o=z.lsp_to_cm(t.range.end),s=e.get_editor_at_virtual_line(i);if(s!==e.get_editor_at_virtual_line(o)){let r=s,a=i,l=Object.assign({},i),c=i.line,d=!1;for(;c<=o.line;){c++;let s=e.get_editor_at_virtual_line({line:c,ch:0});s===r?(l.line=c,l.ch=0,d=!1):(n+=this.replace_fragment(t.newText,r,a,l,i,o),d=!0,a={line:c,ch:0},l={line:c,ch:0},r=s)}d||(n+=this.replace_fragment(t.newText,r,a,l,i,o))}else n+=this.replace_fragment(t.newText,s,i,o,i,o);return n}}st.commands=new Array;const rt=new Set(["()","[]","{}",'""',"''"]);var at=n(6093);class lt extends at.Tooltip{constructor(t){super(t),this.position=t.position,this.movetoLineEnd=t.moveToLineEnd}_setGeometry(){const t=this._editor,e=null==this.position?t.getCursorPosition():this.position,n=t.getOffsetAt(e),i=t.getLine(e.line);if(!i)return;let s;if(this.movetoLineEnd){const e=i.substring(0,n).split(/\W+/),o=e[e.length-1],r=o?n-o.length:n;s=t.getPositionAt(r)}else s=e;if(!s)return;const r=t.getCoordinateForPosition(s),a=window.getComputedStyle(this.node),l=parseInt(a.paddingLeft,10)||0;o.HoverBox.setGeometry({anchor:r,host:t.host,maxHeight:250,minHeight:20,node:this.node,offset:{horizontal:-1*l},privilege:"below",style:a})}}const ct="hideDocs";let dt,ht=!1;class ut extends r.Completer{constructor(t,e){super(t),dt=e,dt.fetch(ct).then((t=>{t&&(console.log("[Kite] Stored Hide Docs State:",t),ht=t)})).catch((t=>console.log(t)))}onUpdateRequest(t){super.onUpdateRequest(t);const e=this.node.querySelector(".jp-Completer-docpanel");ht?null==e||e.classList.add("hidden"):null==e||e.classList.remove("hidden")}}var _t,pt=n(1797),gt=n(9850);class mt{constructor(){this._current=null,this._cursor=null,this._isDisposed=!1,this._completionItems=[],this._options=[],this._original=null,this._query="",this._subsetMatch=!1,this._typeMap={},this._orderedTypes=[],this._stateChanged=new T.Signal(this)}get current(){return this._current}set current(t){if(this._current===t||this._current&&t&&pt.JSONExt.deepEqual(t,this._current))return;const e=this._original;if(!e)return;const n=this._cursor;if(!n)return;const i=this._current=t;if(!i)return void this._stateChanged.emit(void 0);const o=e.text.split("\n")[e.line],s=i.text.split("\n")[i.line];if(!this._subsetMatch&&s.length<o.length)return void this.reset(!0);const{start:r,end:a}=n;let l=i.text.substring(r);const c=e.text.substring(a);l=l.substring(0,l.lastIndexOf(c)),this._query=l,this._stateChanged.emit(void 0)}get cursor(){return this._cursor}set cursor(t){this.original&&(this._cursor=t)}get isDisposed(){return this._isDisposed}get original(){return this._original}set original(t){this._original===t||this._original&&t&&pt.JSONExt.deepEqual(t,this._original)||(this._resetKite(),this._current=this._original=t,this._stateChanged.emit(void 0))}get query(){return this._query}set query(t){this._query=t}get state(){return this._state}set state(t){this._state=t}get stateChanged(){return this._stateChanged}get subsetMatch(){return this._subsetMatch}set subsetMatch(t){this._subsetMatch=t}completionItems(){let t=this._query;return t?this._markup(t):this._completionItems}createPatch(t){const e=this._original,n=this._cursor,i=this._current;if(!e||!n||!i)return;let{start:o,end:s}=n;return s+=i.text.length-e.text.length,{start:o,end:s,value:t}}dispose(){this._isDisposed||(this._isDisposed=!0,T.Signal.clearData(this))}handleCursorChange(t){const e=this.state;this.state=t,(()=>{if(!this._original)return;const{column:e,line:n}=t,{current:i,original:o}=this;if(!o)return;if(n!==o.line)return void this.reset(!0);if(e<o.column)return void this.reset(!0);const{cursor:s}=this;if(!s||!i)return;const r=s.end-s.start,a=o.text.split("\n")[o.line],l=i.text.split("\n")[i.line].length-a.length;e>o.column+r+l&&this.reset(!0)})();const n=this.createPatch(""),i=t.column+t.line+t.text.split("\n").slice(0,t.line).map((t=>t.length)).reduce(((t,e)=>t+e),0);if(n&&(i<n.start||i>n.end))this._resetKite();else if(e){if(t.column-e.column==1&&t.line-e.line==0)return;if(1===t.column&&t.line-e.line==1)return;this.reset(!0)}}handleTextChange(t){this.state=t;const e=this._original;if(!e)return;const{text:n,column:i,line:o}=t,s=n.split("\n")[o][i-1];s&&s.match(/\S/)||t.column>=e.column?this.current=t:this.reset(!1)}items(){return this._filter()}options(){return(0,gt.iter)(this._options)}orderedTypes(){return this._orderedTypes}reset(t=!1){!t&&this._subsetMatch||(this._reset(),this._stateChanged.emit(void 0))}setCompletionItems(t){if(this.isStale())return void this._resetKite();if(pt.JSONExt.deepEqual(t,this._completionItems))return;const e=this.query,n=new Set(t.map((t=>t.label))),i=this._completionItems.filter((t=>!t.noFilter&&!n.has(t.label)&&t.label.toLowerCase().startsWith(e.toLowerCase())));t=t.concat(i),this._completionItems=t,this._orderedTypes=_t.findOrderedCompletionItemTypes(this._completionItems),this._stateChanged.emit(void 0)}setOptions(t,e){const n=(0,gt.toArray)(t||[]),i=e||{};pt.JSONExt.deepEqual(n,this._options)&&pt.JSONExt.deepEqual(i,this._typeMap)||(n.length?(this._options=n,this._typeMap=i,this._orderedTypes=_t.findOrderedTypes(i)):(this._options=[],this._typeMap={},this._orderedTypes=[]),this._stateChanged.emit(void 0))}typeMap(){return this._typeMap}update(t,e){if(this.isStale(e))this._resetKite();else{if(this._original=e,-1!==t.start){const n={start:M.Text.charIndexToJsIndex(t.start,e.text),end:M.Text.charIndexToJsIndex(t.end,e.text)};this.query=e.text.slice(n.start,n.end),this.cursor=n}this.setCompletionItems(t.items)}}_filter(){const t=this._options||[],e=this._query;if(!e)return(0,gt.map)(t,(t=>({raw:t,text:t})));const n=[];for(const i of t)if(i.toLowerCase().startsWith(e.toLowerCase())){const t=gt.StringExt.highlight(i,[...Array(e.length).keys()],_t.mark);n.push({raw:i,text:t.join("")})}return(0,gt.iter)(n)}_markup(t){const e=this._completionItems;let n=[];for(let i of e)if(i.noFilter||i.label.toLowerCase().startsWith(t.toLowerCase())){let e=gt.StringExt.findIndices(i.label.toLowerCase(),t.toLowerCase())||[],o=gt.StringExt.highlight(i.label,e,_t.mark);n.push({label:o.join(""),insertText:i.insertText?i.insertText:i.label,type:i.type,icon:i.icon,documentation:i.documentation,deprecated:i.deprecated})}return n}_reset(){this._current=null,this._cursor=null,this._completionItems=[],this._options=[],this._original=null,this._query="",this._subsetMatch=!1,this._typeMap={},this._orderedTypes=[]}_resetKite(){this._completionItems=this._completionItems.filter((t=>!t.noFilter)),0===this._completionItems.length&&this._reset(),this._stateChanged.emit(void 0)}isStale(t=this._original){return t.text!==this.state.text||t.line!==this.state.line||t.column!==this.state.column}}!function(t){const e=["function","instance","class","module","keyword"],n=e.reduce(((t,e)=>(t[e]=null,t)),{});t.mark=function(t){return`<mark>${t}</mark>`},t.findOrderedCompletionItemTypes=function(t){const n=new Set;t.forEach((t=>{!t.type||e.includes(t.type)||n.has(t.type)||n.add(t.type)}));const i=Array.from(n);return i.sort(((t,e)=>t.localeCompare(e))),e.concat(i)},t.findOrderedTypes=function(t){const i=Object.keys(t).map((e=>t[e])).filter((t=>!!t&&!(t in n))).sort(((t,e)=>t.localeCompare(e)));return e.concat(i)}}(_t||(_t={}));const ft=[class extends st{constructor(){super(...arguments),this.name="Completion"}get completionCharacters(){return null!=this._completionCharacters&&this._completionCharacters.length||(this._completionCharacters=this.connection.getLanguageCompletionCharacters()),this._completionCharacters}afterChange(t){if(t.text.length&&t.text[0].length>1&&!rt.has(t.text[0]))return void this.virtual_editor.console.log("Suppressing completion list due to multi-character text change: ",t.text[0]);let e=this.extract_last_character(t);this.completionCharacters.indexOf(e)>-1&&(this.virtual_editor.console.log("Will invoke completer after",e),this.jupyterlab_components.invoke_completer(V.TriggerCharacter))}},class extends st{constructor(){super(...arguments),this.name="Selection",this.onMousedown=async()=>{var t,e;if(!(null===(e=null===(t=this.virtual_editor)||void 0===t?void 0:t.virtual_document)||void 0===e?void 0:e.document_info))return;let n,i;try{n=this.virtual_editor.getDoc().getCursor("start")}catch(t){return void console.warn("[Kite]: no root position available")}try{i=this.virtual_editor.document_at_root_position(n)}catch(t){return void console.warn("[Kite]: Could not obtain virtual document from position",n)}if(i!==this.virtual_document)return;let o=this.virtual_editor.root_position_to_virtual_position(n);console.log("[Kite] Virtual Position",o),this.connection.sendSelection(o,this.virtual_document.document_info,this.virtual_document.value)}}register(){this.wrapper_handlers.set("mousedown",this.onMousedown),super.register()}remove(){delete this.onMousedown,super.remove()}}];class vt{constructor(){this.cleanup=()=>{this.message="",this.changed.emit("")},this.message="",this.changed=new T.Signal(this)}set(t,e){this.message=t,this.changed.emit(""),null==e&&-1!==e&&setTimeout(this.cleanup,e)}}const wt={"text/x-rsrc":"r","text/x-r-source":"r","text/x-ipython":"python"};class yt{constructor(t,e,n,i,o,s){this.app=t,this.widget=e,this.rendermime_registry=n,this.isDisposed=!1,this.document_connected=new T.Signal(this),this.invoke_command=i,this.adapters=new Map,this.status_message=new vt,this.connection_manager=o,this.state=s,this.widget.context.saveState.connect(this.on_save_state,this),this.connection_manager.closed.connect(this.on_connection_closed,this),this.document_connected.connect(this.connect_completion,this),this.widget.disposed.connect(this.dispose,this)}on_connection_closed(t,{virtual_document:e}){var n;console.log("LSP: connection closed, disconnecting adapter",e.id_path),e===(null===(n=this.virtual_editor)||void 0===n?void 0:n.virtual_document)&&this.dispose()}dispose(){var t,e,n;if(!this.isDisposed){(null===(t=this.virtual_editor)||void 0===t?void 0:t.virtual_document)&&this.disconnect_adapter(null===(e=this.virtual_editor)||void 0===e?void 0:e.virtual_document),this.widget.context.saveState.disconnect(this.on_save_state,this),this.connection_manager.closed.disconnect(this.on_connection_closed,this),this.document_connected.disconnect(this.connect_completion,this),this.widget.disposed.disconnect(this.dispose,this),this.widget.context.model.contentChanged.disconnect(this.update_documents,this);for(let t of this.adapters.values())t.dispose();this.adapters.clear(),this.connection_manager.disconnect_document_signals(this.virtual_editor.virtual_document),this.virtual_editor.dispose(),null===(n=this.current_completion_connector)||void 0===n||n.dispose(),delete this.virtual_editor,delete this.app,delete this.widget,delete this._tooltip,delete this.connection_manager,delete this.current_completion_connector,delete this.rendermime_registry,delete this.widget,this.isDisposed=!0}}get widget_id(){return this.widget.id}get language(){if(wt.hasOwnProperty(this.mime_type))return wt[this.mime_type];{let t=this.mime_type.split(";")[0],[e,n]=t.split("/");return"application"===e||"text"===e?n.startsWith("x-")?n.substr(2):n:this.mime_type}}reload_connection(){null!=this.virtual_editor&&(this.connection_manager.unregister_document(this.virtual_editor.virtual_document),this.virtual_editor.create_virtual_document(),this.connect_document(this.virtual_editor.virtual_document,!0).catch(console.warn))}on_save_state(t,e){if(null!=this.virtual_editor&&"completed"===e)for(let t of this.connection_manager.connections.values())t.sendSaved(this.virtual_editor.virtual_document.document_info)}cancel_completer(){var t;null===(t=this.current_completion_connector)||void 0===t||t.abort()}async invoke_completer(t){if(this.completion_handler){const e=this.completion_handler.editor;let n;try{n=this.completion_handler.completer.model}catch(t){return void console.log("Could not cast model into KiteModel",t)}if(n.original){const i=e.getCursorPosition(),o=e.model.value.text,s={text:o,offset:M.Text.jsIndexToCharIndex(e.getOffsetAt(i),o)},r=n.state,a=await this.current_completion_connector.with_trigger_kind(t,(()=>this.current_completion_connector.fetch(s)));if(n.setCompletionItems&&a)return void n.update(a,r)}}this.current_completion_connector.with_trigger_kind(t,(()=>this.app.commands.execute(this.invoke_command)))}async on_connected(t){let{virtual_document:e}=t;await this.connect_adapter(t.virtual_document,t.connection),this.document_connected.emit(t),await this.virtual_editor.update_documents().then((()=>{this.document_changed(e,e,!0),console.log("LSP: virtual document(s) for",this.document_path,"have been initialized")}))}async connect_document(t,e=!1){t.changed.connect(this.document_changed,this),t.foreign_document_opened.connect(this.on_foreign_document_opened,this);const n=await this.connect(t).catch(console.warn);e&&(n&&n.connection?n.connection.sendOpenWhenReady(t.document_info):console.warn(`Connection for ${t.path} was not opened`))}async on_foreign_document_opened(t,e){const{foreign_document:n}=e;await this.connect_document(n,!0),n.foreign_document_closed.connect(this.on_foreign_document_closed,this)}on_foreign_document_closed(t,e){const{foreign_document:n}=e;n.foreign_document_closed.disconnect(this.on_foreign_document_closed,this),n.foreign_document_opened.disconnect(this.on_foreign_document_opened,this),n.changed.disconnect(this.document_changed,this)}document_changed(t,e,n=!1){let i=this.connection_manager.connections.get(t.id_path),o=this.adapters.get(t.id_path);(null==i?void 0:i.isReady)?null!=o?(this.cancel_completer(),i.sendFullTextChange(t.value,t.document_info),n||this.virtual_editor.with_update_lock((async()=>{await o.updateAfterChange()})).then().catch(console.warn)):console.log("LSP: Skipping document update signal: adapter not ready"):console.log("LSP: Skipping document update signal: connection not ready")}async connect_adapter(t,e){let n=this.create_adapter(t,e);this.adapters.set(t.id_path,n)}disconnect_adapter(t){let e=this.adapters.get(t.id_path);this.adapters.delete(t.id_path),null!=e&&e.dispose()}get_features(t){let e=this.adapters.get(t.id_path);return null==e?void 0:e.features}async connect(t){let e=t.language;console.log(`LSP: will connect using language: ${e}`);let n={virtual_document:t,language:e,document_path:this.document_path},i=await this.connection_manager.connect(n);return await this.on_connected({virtual_document:t,connection:i}),{connection:i,virtual_document:t}}connect_contentChanged_signal(){this.widget.context.model.contentChanged.connect(this.update_documents,this)}create_adapter(t,e){let n=new Array;for(let i of ft){let o=new i(this.virtual_editor,t,e,this,this.status_message);n.push(o)}let i=new et(this.virtual_editor,t,this,n);return console.log("LSP: Adapter for",this.document_path,"is ready."),e.sendOpenWhenReady(t.document_info),i}update_documents(t){this.virtual_editor.update_documents().then().catch(console.warn)}get_position_from_context_menu(){let t=this.app.contextMenuHitTest((()=>!0)),{left:e,top:n}=t.getBoundingClientRect(),i=this.app._contextMenuEvent;return void 0!==i&&(e=i.clientX,n=i.clientY,i.stopPropagation()),this.virtual_editor.coordsChar({left:e,top:n},"window")}get_context(t){let e=this.virtual_editor.document_at_root_position(t),n=this.virtual_editor.root_position_to_virtual_position(t);return{document:e,connection:this.connection_manager.connections.get(e.id_path),virtual_position:n,root_position:t,features:this.get_features(e),editor:this.virtual_editor,app:this.app,adapter:this}}get_context_from_context_menu(){let t=this.get_position_from_context_menu();return this.get_context(t)}create_tooltip(t,e,n){this.remove_tooltip();const i="plaintext"===t.kind?{"text/plain":t.value}:{"text/markdown":t.value},o=new lt({anchor:this.widget.content,bundle:i,editor:this.find_ce_editor(e),rendermime:this.rendermime_registry,position:z.cm_to_ce(n),moveToLineEnd:!1});return tt.Widget.attach(o,document.body),this._tooltip=o,o}remove_tooltip(){void 0!==this._tooltip&&this._tooltip.dispose()}registerKiteModules(t,e,n){if(t instanceof r.CompletionHandler){this.completion_handler=t;const i=new mt;this.completion_handler.completer.model=i;const o=new ut({editor:e,model:i},n);try{this.completion_handler.completer.onUpdateRequest=o.onUpdateRequest}catch(t){console.error(t)}}}}class bt extends yt{constructor(t,e,n,i,o,s){super(e,t,i,"completer:invoke-file",o,s),this.completion_manager=n,this.editor=t.content,this.virtual_editor=new $((()=>this.language),(()=>this.language_file_extension),(()=>this.document_path),this.cm_editor),this.connect_contentChanged_signal(),console.log("LSP: file ready for connection:",this.path),this.connect_document(this.virtual_editor.virtual_document,!1).catch(console.warn),this.editor.model.mimeTypeChanged.connect(this.reload_connection,this)}get document_path(){return this.widget.context.path}get mime_type(){return this.editor.model.mimeType}get language_file_extension(){let t=this.document_path.split(".");return t[t.length-1]}get ce_editor(){return this.editor.editor}get cm_editor(){return this.ce_editor.editor}find_ce_editor(t){return this.editor.editor}connect_completion(){this.current_completion_connector=new X({editor:this.editor.editor,connections:this.connection_manager.connections,virtual_editor:this.virtual_editor});const t=this.completion_manager.register({connector:this.current_completion_connector,editor:this.editor.editor,parent:this.widget});this.registerKiteModules(t,this.editor.editor,this.state)}get path(){return this.widget.context.path}}class xt{constructor(t){this.language=t.language,this.options=t,this.global_expression=new RegExp(t.pattern,"g"),this.test_expression=new RegExp(t.pattern,"g"),this.expression=new RegExp(t.pattern),this.standalone=this.options.is_standalone,this.file_extension=this.options.file_extension}has_foreign_code(t){let e=this.test_expression.test(t);return this.test_expression.lastIndex=0,e}extract_foreign_code(t){let e,n=t.split("\n"),i=new Array,o=this.global_expression.lastIndex,s=this.global_expression.exec(t);for(;null!=s;){let r=s[0],a=null,l=r.replace(this.expression,this.options.extract_to_foreign),c="";void 0!==this.options.extract_arguments&&(c=r.replace(this.expression,this.options.extract_arguments),a=nt(c.length,c.split("\n")));let d=this.global_expression.lastIndex;e=this.options.keep_in_host||null==this.options.keep_in_host?t.substring(o,d):o===s.index?"":t.substring(o,s.index)+"\n";let h=s.index+r.indexOf(l),u=nt(h,n),_=nt(h+l.length,n);i.push({host_code:e,foreign_code:c+l,range:{start:u,end:_},virtual_shift:a}),o=this.global_expression.lastIndex,s=this.global_expression.exec(t)}if(o!==t.length){let e=t.substring(o,t.length);i.push({host_code:e,foreign_code:null,range:null,virtual_shift:null})}return i}}function kt(t,e){let n=[],i=[],o=[];for(let e=0;e<t.length;e+=2){let s=t[e],r=t[e+1];if(null==s)break;"i"===s||"-input"===s?n.push(r):"o"===s||"-output"===s?i.push(r):o.push("-"+s+" "+r)}return{inputs:n,outputs:i,rest:t[t.length+e],others:o}}function Ct(t,e){let{inputs:n,outputs:i,rest:o,others:s}=kt(t,e),r=n.join(", ");r&&(r=", "+r);let a=i.join(", ");return a&&(a+=" = "),{content:o,others:s.join(" "),inputs:r,outputs:a}}function jt(t='"',e=!1){return"(\\S+)?"+"(?:, (\\S+))?".repeat(9)+"( = )?rpy2\\.ipython\\.rmagic\\.RMagics.R\\("+t+(e?"([\\s\\S]*)":"(.*?)")+t+', "(.*?)"'+"(?:, (\\S+))?".repeat(10)+"\\)"}function St(t,...e){let n=[];for(let t=0;t<10&&null!=e[t];t++)n.push(e[t]);let i=[];for(let t=13;t<23&&null!=e[t];t++)i.push(e[t]);let o=i.join(" -i ");o&&(o=" -i "+o);let s=n.join(" -o ");s&&(s=" -o "+s);let r=e[11],a=e[12];return a&&(a=" "+a),{input:o,output:s,other:a,contents:r}}function Et(t){return"(?: -(\\S+) (\\S+))?".repeat(t)}function It(t,...e){let n,i=kt(e,-3);return n=null==i.rest?"":i.rest.startsWith(" ")?i.rest.slice(1):i.rest,n}function Lt(t,...e){let n=kt(e,-3).inputs.map((t=>t+" <- data.frame();")).join(" "),i=It(t,...e);return""!==n&&i&&(n+=" "),n}let Tt={python:[new xt({language:"r",pattern:"^%%R"+Et(10)+"\n([^]*)",extract_to_foreign:It,extract_arguments:Lt,is_standalone:!1,file_extension:"R"}),new xt({language:"r",pattern:"(?:^|\n)%R"+Et(10)+"( .*)?\n?",extract_to_foreign:It,extract_arguments:Lt,is_standalone:!1,file_extension:"R"}),new xt({language:"python",pattern:"^%%(python|python2|python3|pypy)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!0,file_extension:"py"}),new xt({language:"perl",pattern:"^%%(perl)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!0,file_extension:"pl"}),new xt({language:"ruby",pattern:"^%%(ruby)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!0,file_extension:"rb"}),new xt({language:"sh",pattern:"^%%(sh|bash)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!0,file_extension:"sh"}),new xt({language:"html",pattern:"^%%(html --isolated)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!0,file_extension:"html"}),new xt({language:"js",pattern:"^%%(js|javascript)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!1,file_extension:"js"}),new xt({language:"html",pattern:"^%%(html)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!1,file_extension:"html"}),new xt({language:"latex",pattern:"^%%(latex)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!1,file_extension:"latex"}),new xt({language:"markdown",pattern:"^%%(markdown)( .*?)?\n([^]*)",extract_to_foreign:"$3",is_standalone:!1,file_extension:"md"})]};function Mt(t){return t.replace(/\\"/g,'"')}function Pt(t){return t?function(t){return t.replace(/"/g,'\\"')}(t):""}const Rt={python:{line_magics:[{pattern:"!(\\S+)(.*)(\n)?",replacement:'get_ipython().getoutput("$1$2")$3',reverse:{pattern:'get_ipython\\(\\).getoutput\\("(.*?)"\\)(\n)?',replacement:"!$1$2"}},{pattern:"%R"+Et(10)+"(.*)(\n)?",replacement:(t,...e)=>{let n=Ct(e,-4);return`${n.outputs}rpy2.ipython.rmagic.RMagics.R("${n.content}", "${n.others}"${n.inputs})`},reverse:{pattern:jt(),replacement:(t,...e)=>{let n=St(t,...e);return"%R"+n.input+n.output+n.other+n.contents}}},{pattern:"%(\\S+)(.*)(\n)?",replacement:(t,e,n,i)=>`get_ipython().run_line_magic("${e}", "${n=Pt(n)}")${i=i||""}`,reverse:{pattern:'get_ipython\\(\\).run_line_magic\\("(.*?)", "(.*?)"\\)(\n)?',replacement:(t,e,n)=>`%${e}${n=Mt(n)}`}}],cell_magics:[{pattern:"^%%R"+Et(10)+"(\n)?([\\s\\S]*)",replacement:(t,...e)=>{let n=Ct(e,-3);return`${n.outputs}rpy2.ipython.rmagic.RMagics.R("""${n.content}""", "${n.others}"${n.inputs})`},reverse:{pattern:jt('"""',!0),replacement:(t,...e)=>{let n=St(t,...e);return"%%R"+n.input+n.output+n.other+"\n"+n.contents}}},{pattern:"^%%(\\S+)(.*\n)([\\s\\S]*)",replacement:(t,e,n,i,o,s)=>((n=Pt(n))&&(n=n.slice(0,-1)),`get_ipython().run_cell_magic("${e}", "${n}", """${i=i.replace(/"""/g,'\\"\\"\\"')}""")`),reverse:{pattern:'^get_ipython\\(\\).run_cell_magic\\("(.*?)", "(.*?)", """([\\s\\S]*)"""\\)',replacement:(t,e,n,i)=>(i=i.replace(/\\"\\"\\"/g,'"""'),`%%${e}${n=Mt(n)}\n${i}`)}}]}};class Ot{constructor(t){this.virtual_editor=t}markText(t,e,n){let i=this.virtual_editor.virtual_document.get_editor_at_source_line(t),o=this.virtual_editor;return i.getDoc().markText(o.transform_from_root_to_editor(t),o.transform_from_root_to_editor(e),n)}getCursor(t){let e=this.virtual_editor.notebook.activeCell;if(null==e)return;let n=e.editor.editor.getDoc().getCursor(t);return this.virtual_editor.transform_from_notebook_to_root(e,n)}}class Kt extends A{constructor(t,e,n,i,o,s,r){return super(n,i,(()=>r()+"."+i()),o,s,!1),this.notebook=t,this.wrapper=e,this.has_cells=!0,this.cell_to_corresponding_source_line=new Map,this.cm_editor_to_cell=new Map,this.overrides_registry=o,this.code_extractors=s,this.language=n,this._proxy=new Proxy(this,{get:function(t,e,n){return e in t?Reflect.get(t,e,n):void console.warn(`Unimplemented method ${e} for VirtualEditorForNotebook`)}}),this._proxy}dispose(){this.isDisposed||(this.cm_editor_to_cell.clear(),this.cell_to_corresponding_source_line.clear(),super.dispose(),this.forEveryBlockEditor=null,this._proxy=null)}transform_from_notebook_to_root(t,e){let n=this.cell_to_corresponding_source_line.get(t);if(void 0===n)throw Error("Cell not found in cell_line_map");return Object.assign(Object.assign({},e),{line:e.line+n})}transform_editor_to_root(t,e){let n=this.cm_editor_to_cell.get(t);return this.transform_from_notebook_to_root(n,e)}transform_from_root_to_editor(t){return this.virtual_document.transform_source_to_editor(t)}get_editor_index(t){let e=this.get_cell_at(t);return this.notebook.widgets.findIndex((t=>e===t))}get_cm_editor(t){return this.get_editor_at_root_line(t)}addKeyMap(t,e){}addLineClass(t,e,n){}addLineWidget(t,e,n){}addOverlay(t,e){for(let n of this.notebook.widgets)n.editor.editor.addOverlay(t,e)}addPanel(t,e){}charCoords(t,e){try{return this.get_editor_at_root_line(t).charCoords(t,e)}catch(t){return console.log(t),{bottom:0,left:0,right:0,top:0}}}coordsChar(t,e){for(let n of this.notebook.widgets){let i=n.editor.editor.coordsChar(t,e);if(1!==i.outside)return this.transform_from_notebook_to_root(n,i)}}cursorCoords(t,e){return"boolean"!=typeof t?this.get_editor_at_root_line(t).cursorCoords(this.transform_from_root_to_editor(t)):{bottom:0,left:0,top:0}}get any_editor(){return this.notebook.widgets[0].editor.editor}defaultCharWidth(){return this.any_editor.defaultCharWidth()}defaultTextHeight(){return this.any_editor.defaultTextHeight()}endOperation(){for(let t of this.notebook.widgets)t.editor.editor.endOperation()}execCommand(t){for(let e of this.notebook.widgets)e.editor.editor.execCommand(t)}getDoc(){return new Ot(this)}get_editor_at_root_line(t){return this.virtual_document.root.get_editor_at_source_line(t)}getTokenAt(t,e){if(void 0!==t)return this.get_editor_at_root_line(t).getTokenAt(this.transform_from_root_to_editor(t))}getTokenTypeAt(t){return this.virtual_document.get_editor_at_source_line(t).getTokenTypeAt(this.transform_from_root_to_editor(t))}get_cell_at(t){let e=this.get_editor_at_virtual_line(t);return this.cm_editor_to_cell.get(e)}get_editor_at_virtual_line(t){return this.virtual_document.get_editor_at_virtual_line(t)}perform_documents_update(){this.isDisposed||(this.virtual_document.clear(),this.cell_to_corresponding_source_line.clear(),this.cm_editor_to_cell.clear(),this.notebook.isDisposed||this.notebook.widgets.every((t=>{let e=t.editor.editor;if(this.cm_editor_to_cell.set(e,t),"code"===t.model.type){let n=e.getValue();this.cell_to_corresponding_source_line.set(t,this.virtual_document.last_source_line),this.virtual_document.append_code_block(n,e)}return!0})))}getWrapperElement(){return this.wrapper}heightAtLine(t,e,n){return 0}isReadOnly(){return!1}lineAtHeight(t,e){return 0}addEventListener(t,e){this.forEveryBlockEditor((n=>{n.getWrapperElement().addEventListener(t,e)}))}forEveryBlockEditor(t,e=!0){const n=new Set;for(let e of this.notebook.widgets){let i=e.editor.editor;"code"===e.model.type&&(n.add(e),t(i))}e&&this.notebook.activeCellChanged.connect(((e,i)=>{if(null==i)return;let o=i.editor.editor;n.has(i)||"code"!==i.model.type||t(o)}))}find_cell_by_editor(t){let e=this.notebook.widgets;for(let n=0;n<e.length;n++){let i=e[n];if(i.editor.editor===t)return{cell_id:n,cell:i}}}}class Ut extends yt{constructor(t,e,n,i,o,s){super(e,t,i,"completer:invoke-notebook",o,s),this.is_ready=()=>{var t;return!this.widget.isDisposed&&this.widget.context.isReady&&this.widget.content.isVisible&&this.widget.content.widgets.length>0&&null!=(null===(t=this.widget.context.sessionContext.session)||void 0===t?void 0:t.kernel)},this.editor=t.content,this.completion_manager=n,this.init_once_ready().catch(console.warn)}async update_language_info(){this._language_info=(await this.widget.context.sessionContext.session.kernel.info).language_info}async on_kernel_changed(t,e){if(e.newValue)try{await this.update_language_info(),console.log(`LSP: Changed to ${this._language_info.name} kernel, reconnecting`),await(0,L.EU)(this.is_ready,-1),this.reload_connection()}catch(t){console.warn(t),this.reload_connection()}else console.log("LSP: kernel was shut down")}dispose(){this.isDisposed||(this.widget.context.sessionContext.kernelChanged.disconnect(this.on_kernel_changed,this),this.widget.content.activeCellChanged.disconnect(this.on_completions,this),this.current_completion_handler&&(delete this.current_completion_handler.connector,delete this.current_completion_handler.editor,delete this.current_completion_handler),super.dispose())}get document_path(){return this.widget.context.path}language_info(){return this._language_info}get mime_type(){let t=this.language_info();return t?t.mimetype:this.widget.content.codeMimetype}get language_file_extension(){let t=this.language_info();return t?t.file_extension.replace(".",""):null}find_ce_editor(t){return this.virtual_editor.cm_editor_to_cell.get(t).editor}async init_once_ready(){console.log("LSP: waiting for",this.document_path,"to fully load"),await this.widget.context.sessionContext.ready,await(0,L.EU)(this.is_ready,-1),await this.update_language_info(),console.log("LSP:",this.document_path,"ready for connection"),this.virtual_editor=new Kt(this.widget.content,this.widget.node,(()=>this.language),(()=>this.language_file_extension),Rt,Tt,(()=>this.document_path)),this.connect_contentChanged_signal(),this.connect_document(this.virtual_editor.virtual_document,!1).catch(console.warn),this.widget.context.sessionContext.kernelChanged.connect(this.on_kernel_changed,this)}set_completion_connector(t){this.current_completion_connector&&delete this.current_completion_connector,this.current_completion_connector=new X({editor:t.editor,connections:this.connection_manager.connections,virtual_editor:this.virtual_editor,session:this.widget.sessionContext.session})}connect_completion(){const t=this.widget.content.activeCell;if(console.log("Connecting Completion Notebook"),null==t)return;this.set_completion_connector(t);const e=this.completion_manager.register({connector:this.current_completion_connector,editor:t.editor,parent:this.widget});this.current_completion_handler=e,this.registerKiteModules(e,t.editor,this.state),this.widget.content.activeCellChanged.connect(this.on_completions,this)}on_completions(t,e){null!=e&&(this.current_completion_connector.abort(),this.set_completion_connector(e),this.current_completion_handler.editor=e.editor,this.current_completion_handler.connector=this.current_completion_connector)}}const Dt=new Map,Nt=new Map,At="kite",$t=[{id:"kite:copilot",options:{label:"Kite: Open Copilot",execute:()=>{window.open("kite://home")}}},{id:"kite:settings",options:{label:"Kite: Engine Settings",execute:()=>{window.open("kite://settings")}}},{id:"kite:help",options:{label:"Kite: Help",execute:()=>{window.open("https://help.kite.com/category/138-jupyterlab-plugin")}}},{id:"kite:toggle-docs",options:{label:"Kite: Toggle Docs Panel",execute:()=>{ht=!ht,dt.save(ct,ht).catch((t=>console.log(t)))}}}],qt="onboardingShown";class Wt{constructor(t,e,n,i,o){this.app=t,this.palette=e,this.documentManager=n,this.state=i,this.connectionManager=o,this.registerCommand()}registerCommand(){const t={id:"kite:tutorial",options:{label:"Kite: Tutorial",execute:()=>{this._show().catch((t=>console.log(t)))}}};this.app.commands.hasCommand(t.id)||(this.app.commands.addCommand(t.id,t.options),this.palette.addItem({command:t.id,category:At}))}async showOnBoot(){await this.state.fetch(qt)||this._show().catch((t=>console.log(t))),this.state.save(qt,!0).catch((t=>console.log(t)))}async _fetch(){const t={virtual_document:new K("python","",{},{},!1,".py",!1),language:"python",document_path:""},e=await this.connectionManager.connect(t);return e?e.fetchKiteOnboarding():""}async _show(){const t=await this._fetch();t&&this.documentManager.openOrReveal(t)}}var Ht,Zt=n(5653),Jt=n(9618),Ft=n(2222),Bt=n.n(Ft),Vt=n(149);g()(Vt.Z,{insert:"head",singleton:!1}),Vt.Z.locals,function(t){t.ServerExtensionUnreachable="ServerExtensionUnreachable",t.RequirementsNotMet="RequirementsNotMet",t.KiteEngineNotInstalled="KiteNotInstalled",t.BelowMinJLabVersion="BelowMinJLabVersion",t.IncompatibleJLabLSPPlugin="HasIncompatibleJLabLSP",t.JLabKiteHasUpdate="JLabKiteHasUpdate",t.Healthy="Healthy"}(Ht||(Ht={}));const zt="3.0.0";class Gt extends Zt.ListModel{constructor(t,e,n,i,o){super(t,e,n),this.connectionManager=i,this.languageServerManager=o}async checkHealth(){try{const t=await this.getHealth();await this.notifyHealth(t),t===Ht.IncompatibleJLabLSPPlugin&&this.trackIncompatiblity().catch((t=>console.log(t)))}catch(t){console.log("Health check failed:",t)}}async notifyHealth(t){const e={autoClose:!1,closeOnClick:!1,className:"--jp-kite-notifcontainer"};let n;switch(t){case Ht.ServerExtensionUnreachable:n=await Jt.INotification.notify(v().createElement(Xt,{title:"Server Extension Unreachable"},v().createElement("p",{className:"--jp-kite-innernotif-main-msg"},"The jupyterlab-kite extension will not work because the jupyter-kite server extension could not be reached."),v().createElement("p",null,"To fix this, please ensure the jupyter-kite server extension is installed and active (`jupyter serverextension list`), then restart the JupyterLab process."),v().createElement(Yt,{label:"Fix This",onClick:()=>{window.open("https://github.com/kiteco/jupyterlab-kite#installing-the-kite-extension-for-jupyterlab","_blank"),Jt.INotification.dismiss(n)}})),Object.assign(Object.assign({},e),{type:"error"}));break;case Ht.RequirementsNotMet:n=await Jt.INotification.notify(v().createElement(Xt,{title:"Kite is missing some dependencies"},v().createElement("p",{className:"--jp-kite-innernotif-main-msg"},"The jupyterlab-kite extension will not work because you using an unsupported version of JupyterLab and you are missing the desktop application."),v().createElement("p",null,"To fix this, please upgrade JupyterLab to version 2.2 or later and install the Kite Engine desktop application."),v().createElement(Yt,{label:"Fix This",onClick:()=>{window.open("https://www.kite.com/download?utm_source=jupyterlab-plugin&utm_content=update-jlab","_blank"),Jt.INotification.dismiss(n)}})),Object.assign(Object.assign({},e),{type:"error"}));break;case Ht.BelowMinJLabVersion:n=await Jt.INotification.notify(v().createElement(Xt,{title:"Kite is missing some dependencies"},v().createElement("p",{className:"--jp-kite-innernotif-main-msg"},"The jupyterlab-kite extension will not work because you are using an unsupported version of JupyterLab."),v().createElement("p",null,"To fix this, please upgrade JupyterLab to version 2.2 or later."),v().createElement(Yt,{label:"Fix This",onClick:()=>{window.open("https://stackoverflow.com/questions/55772171/how-to-update-jupyterlab-using-conda-or-pip","_blank"),Jt.INotification.dismiss(n)}})),Object.assign(Object.assign({},e),{type:"error"}));break;case Ht.KiteEngineNotInstalled:n=await Jt.INotification.notify(v().createElement(Xt,{title:"Kite is missing some dependencies"},v().createElement("p",{className:"--jp-kite-innernotif-main-msg"},"The jupyterlab-kite extension will not work because you are missing the Kite Engine desktop application."),v().createElement("p",null,"To fix this, please install the Kite Engine desktop application."),v().createElement(Yt,{label:"Fix This",onClick:()=>{window.open("https://www.kite.com/download?utm_source=jupyterlab-plugin","_blank"),Jt.INotification.dismiss(n)}})),Object.assign(Object.assign({},e),{type:"error"}));break;case Ht.IncompatibleJLabLSPPlugin:n=await Jt.INotification.notify(v().createElement(Xt,{title:"Kite may not work properly in your environment"},v().createElement("p",{className:"--jp-kite-innernotif-main-msg"},"The jupyterlab-kite extension is incompatible with your JupyterLab configuration."),v().createElement("p",null,"It will not work with the jupyterlab-lsp extension."),v().createElement(Yt,{label:"Learn More",onClick:()=>{window.open("https://help.kite.com/article/143-how-to-install-the-jupyterlab-plugin#troubleshooting","_blank"),Jt.INotification.dismiss(n)}})),Object.assign(Object.assign({},e),{type:"warning"}));break;case Ht.JLabKiteHasUpdate:n=await Jt.INotification.notify(v().createElement(v().Fragment,null,v().createElement(Xt,{title:"There is a new version of Kite available"},v().createElement("p",{className:"--jp-kite-innernotif-main-msg"},"Please update your jupyterlab-kite extension with the terminal commands:"),v().createElement("ul",{className:"--jp-kite-innernotif-list --jp-kite-innernotif-no-bullets"},v().createElement("li",{className:"--jp-kite-innernotif-li"},"pip install --upgrade jupyter-kite"),v().createElement("li",{className:"--jp-kite-innernotif-li"},"jupyter labextension update @kiteco/jupyterlab-kite")),v().createElement(Yt,{label:"Update",onClick:()=>{window.open("https://help.kite.com/article/143-how-to-install-the-jupyterlab-plugin#updating-the-plugin"),Jt.INotification.dismiss(n)}}))),Object.assign(Object.assign({},e),{type:"info"}))}}async getHealth(){try{await this.languageServerManager.fetchSessions()}catch(t){return Ht.ServerExtensionUnreachable}const t=await this.languageServerManager.fetchKiteInstalled(),e=M.PageConfig.getOption("appVersion");if(!t&&Bt().lt(e,zt))return Ht.RequirementsNotMet;if(!t)return Ht.KiteEngineNotInstalled;if(Bt().lt(e,zt))return Ht.BelowMinJLabVersion;const n=await this.queryInstalled(!1);return n["@krassowski/jupyterlab-lsp"]?Ht.IncompatibleJLabLSPPlugin:Zt.ListModel.entryHasUpdate(n["@kiteco/jupyterlab-kite"])?Ht.JLabKiteHasUpdate:Ht.Healthy}async trackIncompatiblity(){const t={virtual_document:new K("python","",{},{},!1,".py",!1),language:"python",document_path:""},e=await this.connectionManager.connect(t);e&&e.track("mixpanel","jupyterlab_incompatibility",{type:"jupyter-lab-lsp"})}}function Xt(t){return v().createElement(v().Fragment,null,v().createElement("p",{className:"--jp-kite-innernotif-title"},t.title),v().createElement("div",{className:"--jp-kite-innernotif-body"},t.children))}function Yt(t){return v().createElement("div",{className:"--jp-kite-buttonbar"},v().createElement("div",{className:"--jp-kite-buttonbar-spacer"}),v().createElement("button",{className:"--jp-kite-innernotif-button",onClick:t.onClick},t.label))}Gt.CreateAsync=async(t,e,n,i,o)=>{const s=await n.load("@jupyterlab/extensionmanager-extension:plugin");return new Gt(t,e,s,i,o)};var Qt=n(4834);class te{constructor(t){this._sessionsChanged=new T.Signal(this),this._sessions=new Map,this._settings=t.settings||Qt.ServerConnection.makeSettings(),this._baseUrl=t.baseUrl||M.PageConfig.getBaseUrl(),this.fetchSessions().catch(console.warn)}get statusUrl(){return M.URLExt.join(this._baseUrl,E.URL_NS,"status")}get sessionsChanged(){return this._sessionsChanged}get sessions(){return this._sessions}getServerId(t){for(const[e,n]of this._sessions.entries())if(t.language&&n.spec.languages&&-1!==n.spec.languages.indexOf(t.language))return e;return""}async fetchSessions(){let t,e=await Qt.ServerConnection.makeRequest(this.statusUrl,{method:"GET"},this._settings);if(!e.ok)throw new Error(e.statusText);try{t=(await e.json()).sessions}catch(t){return void console.warn(t)}for(const e of Object.keys(t))this._sessions.has(e)?Object.assign(this._sessions.get(e),t[e]):this._sessions.set(e,t[e]);const n=this._sessions.keys();for(const e in n)t[e]||this._sessions.delete(e);this._sessionsChanged.emit(void 0)}get kiteInstalledUrl(){return M.URLExt.join(M.PageConfig.getBaseUrl(),E.URL_NS,"kite_installed")}async fetchKiteInstalled(){const t=await Qt.ServerConnection.makeRequest(this.kiteInstalledUrl,{method:"GET"},this._settings);return t.ok&&await t.json()}}var ee=i.JupyterFrontEnd.IPaths;const ne={id:"@kiteco/jupyterlab-kite:plugin",requires:[l.IEditorTracker,c.INotebookTracker,h.ISettingRegistry,o.ICommandPalette,a.IDocumentManager,r.ICompletionManager,d.IRenderMimeRegistry,ee,i.ILabShell,_.IStatusBar,u.IStateDB],activate:async(t,e,n,i,o,r,a,l,c,d,h,u)=>{!function(t,e){$t.forEach((n=>{t.commands.addCommand(n.id,n.options),e.addItem({command:n.id,category:At})}))}(t,o);const _=new te({}),p=new x.R(_),g=new P({language_server_manager:_,kite_status_model:p});(await Gt.CreateAsync(t,t.serviceManager,i,g,_)).checkHealth().catch((t=>console.log(t)));const m=new Wt(t,o,r,u,g),f=new b(p);d.currentChanged.connect((()=>{const t=d.currentWidget;if(!t)return;let i=null;if(n.has(t)){let e=t.id;i=Nt.get(e)}else if(e.has(t)){let e=t.content.id;i=Dt.get(e)}null!=i&&(f.model.adapter=i),m.showOnBoot().catch((t=>console.log(t)))})),h.registerStatusItem("@kiteco/jupyterlab-kite:language-server-status",{item:f,align:"left",rank:1,isActive:()=>!(!d.currentWidget||!e.currentWidget&&!n.currentWidget||d.currentWidget!==e.currentWidget&&d.currentWidget!==n.currentWidget)}),e.widgetUpdated.connect(((t,e)=>{console.log(t),console.log(e)}));const v=e=>{let n=e.content;if(n.editor instanceof s.CodeMirrorEditor){let i=new bt(e,t,a,l,g,u);Dt.set(n.id,i);const o=()=>{Dt.delete(n.id),e.disposed.disconnect(o),e.context.pathChanged.disconnect(s),i.dispose()},s=()=>{o(),v(e)};e.disposed.connect(o),e.context.pathChanged.connect(s)}};e.widgetAdded.connect(((t,e)=>{v(e)}));const w=e=>{let n=new Ut(e,t,a,l,g,u);Nt.set(e.id,n);const i=()=>{Nt.delete(e.id),e.disposed.disconnect(i),e.context.pathChanged.disconnect(o),n.dispose()},o=()=>{i(),w(e)};e.context.pathChanged.connect(o),e.disposed.connect(i)};n.widgetAdded.connect((async(t,e)=>{w(e)}))},autoStart:!0}},6988:(t,e,n)=>{"use strict";async function i(t){return new Promise((e=>{setTimeout((()=>{e()}),t)}))}function o(t,e=35,n=50,o=(t=>t)){return new Promise((async(s,r)=>{let a=0;for(;!0!==t();){if(a+=1,-1!==e&&a>e){r("Too many retrials");break}n=o(n),await i(n)}s(t)}))}n.d(e,{_v:()=>i,EU:()=>o,Gl:()=>s}),n(4810);class s extends Map{constructor(t,e){super(e),this.default_factory=t}get(t){return this.get_or_create(t)}get_or_create(t,...e){if(this.has(t))return super.get(t);{let n=this.default_factory(t,...e);return this.set(t,n),n}}}}}]);